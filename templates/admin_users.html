{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

<h3 class="mb-3">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>

<a href="/admin/users/create" class="btn btn-primary mb-3">
‚ûï T·∫°o user m·ªõi
</a>
<form method="get" class="row g-2 mb-3">

    <!-- T√åM USERNAME -->
    <div class="col-12 col-md-5">
        <input type="text"
               name="q"
               value="{{ q }}"
               class="form-control form-control-lg"
               placeholder="üîç T√¨m theo t√†i kho·∫£n">
    </div>

    <!-- L·ªåC KHOA -->
    <div class="col-12 col-md-4">
        <select name="dept" class="form-select">
            <option value="">üè• T·∫•t c·∫£ khoa</option>
            <option value="HSCC" {% if dept=="HSCC" %}selected{% endif %}>HSCC</option>
            <option value="SAN">S·∫£n</option>
            <option value="NHI">Nhi</option>
            <option value="NHIEM">Nhi·ªÖm</option>
            <option value="NG">Ngo·∫°i</option>
            <option value="NTH">N·ªôi T·ªïng h·ª£p</option>
            <option value="NTM">N·ªôi Tim M·∫°ch</option>
            <option value="DUOC">D∆∞·ª£c</option>
            <option value="XN">X√©t nghi·ªám</option>
            <option value="CDHA">CƒêHA</option>
            <option value="CNTT">CNTT</option>
            <option value="KHTH">KHTH</option>
            <option value="DD">ƒêi·ªÅu d∆∞·ª°ng</option>
            <option value="KT">K·∫ø to√°n</option>
            <option value="TCHC">TCHC</option>
            <option value="GMHS">GMHS</option>
            <option value="CDHA">CƒêHA</option>
            <option value="KHTH">KHTH</option>
            <option value="VTYT">VTYT</option>
            <option value="DDUONG">Dinh d∆∞·ª°ng</option>
            <option value="KSNK">KSNK</option>
            <option value="KB">Kh√°m b·ªánh</option>
            <!-- th√™m khoa n·∫øu c·∫ßn -->
        </select>
    </div>

    <!-- N√öT -->
    <div class="col-12 col-md-3">
        <button class="btn btn-primary w-100">
            üîé T√¨m ki·∫øm
        </button>
    </div>

</form>

<div class="table-responsive">
<table class="table table-bordered table-hover align-middle">
<thead class="table-dark">
<tr>
    <th>#</th>
    <th>T√†i kho·∫£n</th>
    <th>Email</th>
    <th>Khoa / Ph√≤ng</th>
    <th>Quy·ªÅn</th>
    <th width="180">Thao t√°c</th>
    <th>Tr·∫°ng th√°i</th>

</tr>
</thead>

<tbody>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} text-center">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% for u in users %}
<tr class="{% if not u[5] %}table-secondary{% endif %}
            {% if highlight and highlight|int == u[0] %}table-success{% endif %}
    ">
    <td>{{ u[0] }}</td>
    <td>{{ u[1] }}</td>
    <td>{{ u[2] }}</td>
    <td>{{ u[4] }}</td>
    <td>
        <span class="badge bg-{{ 'danger' if u[3]=='admin' else 'secondary' }}">
            {{ u[3] }}
        </span>
    </td>
    <td>
        {% if u[5] %}
        <a href="/admin/users/edit/{{ u[0] }}"
           class="btn btn-sm btn-warning">‚úèÔ∏è</a>
    
        <a href="/admin/users/reset/{{ u[0] }}"
           class="btn btn-sm btn-info">üîë</a>
        {% endif %}


       {% if u[3] != 'admin' %}
        <button type="button"
            class="btn btn-sm btn-danger"
            onclick="confirmUserAction({{ u[0] }})">
            ‚ùå
        </button>
        {% endif %}

    </td>
    <td>
    {% if u[5] %}
        <span class="badge bg-success">Ho·∫°t ƒë·ªông</span>
    {% else %}
        <form method="post"
              action="/admin/users/unlock/{{ u[0] }}"
              style="display:inline"
              onsubmit="return confirm('M·ªü kh√≥a user n√†y?')">
            <button class="btn btn-sm btn-success">
                üîì M·ªü kh√≥a
            </button>
        </form>
    {% endif %}
    </td>


</tr>
{% endfor %}
</tbody>
</table>
</div>

</div>
<script>
function confirmUserAction(userId) {
    if (confirm("B·∫°n mu·ªën T·∫†M KH√ìA user n√†y?\n\nOK = T·∫°m kh√≥a\nCancel = X√≥a vƒ©nh vi·ªÖn")) {

        // üëâ T·∫†M KH√ìA
        fetch(`/admin/users/lock/${userId}`, {
            method: "POST"
        }).then(() => location.reload());

    } else {

        // üëâ X√ìA Vƒ®NH VI·ªÑN
        if (confirm("‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN USER?\nKh√¥ng th·ªÉ kh√¥i ph·ª•c!")) {
            fetch(`/admin/users/delete/${userId}`, {
                method: "POST"
            }).then(() => location.reload());
        }
    }
}
</script>

{% endblock %}
